# MetalQuery - Architecture & Flow Documentation

## Table of Contents
1. [Overview](#overview)
2. [Core Principle](#core-principle)
3. [System Architecture](#system-architecture)
4. [RBAC Flow](#rbac-flow)
5. [Request Flow](#request-flow)
6. [Security Architecture](#security-architecture)
7. [File Structure](#file-structure)
8. [Configuration](#configuration)

---

## Overview

**MetalQuery** is a Natural Language to SQL (NL2SQL) chatbot system for industrial furnace KPI analysis. It also supports document-based Q&A from BRD PDFs.

### Key Capabilities
| Feature | Description |
|---------|-------------|
| NL-to-SQL | Convert questions to PostgreSQL queries |
| BRD RAG | Answer questions from PDF documents |
| Hybrid Routing | Auto-detect SQL vs BRD questions |
| Speech-to-Text | Voice input with Faster-Whisper |
| Export Features | CSV export, chart PNG download |
| RBAC | Table-level access control |
| Security | 12-layer defense system |

### Technology Stack
| Layer | Technology | Port |
|-------|------------|------|
| Frontend | React 18 | 5173 |
| Backend Gateway | Django 4.2 | 8000 |
| NLP Service | FastAPI + LangChain | 8003 |
| LLM Provider | Groq (llama-3.3-70b) | Cloud |
| Database | PostgreSQL | 5432 |
| Vector Store | ChromaDB (Multimodal) | Embedded |

---

## Core Principle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     LLM NEVER TOUCHES DATABASE DIRECTLY                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚    USER     â”‚         â”‚     LLM     â”‚         â”‚  DATABASE   â”‚              â”‚
â”‚   â”‚   Query     â”‚         â”‚   (Groq)    â”‚         â”‚ (PostgreSQL)â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚          â”‚                       â”‚                       â”‚                      â”‚
â”‚          â”‚                       â”‚ Generates             â”‚                      â”‚
â”‚          â”‚                       â”‚ SQL TEXT              â”‚                      â”‚
â”‚          â”‚                       â”‚ only                  â”‚                      â”‚
â”‚          â”‚                       â–¼                       â”‚                      â”‚
â”‚          â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                      â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚     DJANGO      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                         â”‚   (Gatekeeper)  â”‚                                     â”‚
â”‚                         â”‚                 â”‚                                     â”‚
â”‚                         â”‚ â€¢ Validates SQL â”‚                                     â”‚
â”‚                         â”‚ â€¢ Checks RBAC   â”‚                                     â”‚
â”‚                         â”‚ â€¢ Executes queryâ”‚                                     â”‚
â”‚                         â”‚ â€¢ Owns DB conn  â”‚                                     â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                                                                  â”‚
â”‚   KEY: LLM has NO database connection, NO credentials, NO direct access         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              USER INTERFACE                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                        React Frontend (Port 5173)                        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  Chat Input  â”‚  â”‚  Message     â”‚  â”‚  Results     â”‚  â”‚  SQL        â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  Component   â”‚  â”‚  Display     â”‚  â”‚  Table       â”‚  â”‚  Viewer     â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  localStorage: authToken (Bearer token for RBAC)                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â”‚ HTTP POST /api/chatbot/chat/
                                        â”‚ Authorization: Bearer <token>
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           DJANGO BACKEND (Port 8000)                             â”‚
â”‚                        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                           â”‚
â”‚                         SECURITY GATEWAY - DB OWNER                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ Rate Limiter â”‚  â”‚ RBAC Service â”‚  â”‚ SQL Validatorâ”‚  â”‚ Audit       â”‚  â”‚    â”‚
â”‚  â”‚  â”‚ (30 req/min) â”‚  â”‚ (Token â†’     â”‚  â”‚ (Defense in  â”‚  â”‚ Logger      â”‚  â”‚    â”‚
â”‚  â”‚  â”‚              â”‚  â”‚  Tables)     â”‚  â”‚  Depth)      â”‚  â”‚             â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                               â”‚
          â”‚ HTTP POST /api/v1/chat                        â”‚ SQL Query
          â”‚ {question, allowed_tables}                    â”‚
          â–¼                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   NLP MICROSERVICE (Port 8003)  â”‚         â”‚      POSTGRESQL DATABASE        â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚         â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚   AI BOUNDARY - NO DB ACCESS    â”‚         â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Security Layers            â”‚â”‚         â”‚  â”‚  29 KPI Tables              â”‚â”‚
â”‚  â”‚  â”œâ”€â”€ Flipping Detector      â”‚â”‚         â”‚  â”‚  3 Core Process Tables      â”‚â”‚
â”‚  â”‚  â”œâ”€â”€ Prompt Validator       â”‚â”‚         â”‚  â”‚  6 Master/Config Tables     â”‚â”‚
â”‚  â”‚  â”œâ”€â”€ Red Team Detector      â”‚â”‚         â”‚  â”‚                             â”‚â”‚
â”‚  â”‚  â”œâ”€â”€ Guardrails AI          â”‚â”‚         â”‚  â”‚  Auth Tables (RBAC):        â”‚â”‚
â”‚  â”‚  â””â”€â”€ Query Guard            â”‚â”‚         â”‚  â”‚  â€¢ users_usertoken          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚         â”‚  â”‚  â€¢ users_user               â”‚â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚         â”‚  â”‚  â€¢ users_userrole           â”‚â”‚
â”‚  â”‚  Schema Filtering           â”‚â”‚         â”‚  â”‚  â€¢ users_rolepermission     â”‚â”‚
â”‚  â”‚  â”œâ”€â”€ Filter by allowed_tablesâ”‚         â”‚  â”‚  â€¢ users_role_kpis          â”‚â”‚
â”‚  â”‚  â””â”€â”€ LLM only sees permittedâ”‚â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Groq LLM API               â”‚â”‚
â”‚  â”‚  (llama-3.3-70b-versatile)  â”‚â”‚
â”‚  â”‚  Generates SQL TEXT only    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## RBAC Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          RBAC TABLE ACCESS CONTROL                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Authorization: Bearer xyz123...
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: Token Lookup                                                            â”‚
â”‚                                                                                  â”‚
â”‚  users_usertoken                    users_user                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ key = "xyz123"  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ id = 42         â”‚                          â”‚
â”‚  â”‚ user_id = 42    â”‚               â”‚ is_superuser    â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                             â”‚                                    â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚                     â”‚                                               â”‚            â”‚
â”‚                     â–¼                                               â–¼            â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚        â”‚ IF is_superuser    â”‚                          â”‚ IF regular user    â”‚    â”‚
â”‚        â”‚ Return ALL 29      â”‚                          â”‚ Continue to        â”‚    â”‚
â”‚        â”‚ tables             â”‚                          â”‚ permission lookup  â”‚    â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                   â”‚
                                                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: Role Lookup                                                             â”‚
â”‚                                                                                  â”‚
â”‚  users_userrole                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚  â”‚ user_id = 42    â”‚                                                            â”‚
â”‚  â”‚ role_id = 5     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚              â”‚
â”‚                                                                   â”‚              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚              â”‚                                                    â”‚              â”‚
â”‚              â–¼                                                    â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ users_rolepermission    â”‚                      â”‚ users_role_kpis         â”‚   â”‚
â”‚  â”‚ role_id = 5             â”‚                      â”‚ role_id = 5             â”‚   â”‚
â”‚  â”‚ function_master_id:     â”‚                      â”‚ kpi_metric_code:        â”‚   â”‚
â”‚  â”‚  â€¢ PLT_CFG (view=true)  â”‚                      â”‚  â€¢ OEE                  â”‚   â”‚
â”‚  â”‚  â€¢ FUR_MNT (view=true)  â”‚                      â”‚  â€¢ DOWNTIME             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚  â€¢ YIELD                â”‚   â”‚
â”‚              â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â–¼                                                 â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ FUNCTION_TABLE_MAPPING  â”‚                      â”‚ KPI_TABLE_MAPPING       â”‚   â”‚
â”‚  â”‚                         â”‚                      â”‚                         â”‚   â”‚
â”‚  â”‚ PLT_CFG â†’ plant_plant   â”‚                      â”‚ OEE â†’ kpi_oee           â”‚   â”‚
â”‚  â”‚ FUR_MNT â†’ furnace_*     â”‚                      â”‚ DOWNTIME â†’ kpi_downtime â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚ YIELD â†’ kpi_yield       â”‚   â”‚
â”‚              â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â”‚                                                 â”‚                 â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                    â”‚                                             â”‚
â”‚                                    â–¼                                             â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                     â”‚      allowed_tables          â”‚                             â”‚
â”‚                     â”‚                              â”‚                             â”‚
â”‚                     â”‚ {"plant_plant",              â”‚                             â”‚
â”‚                     â”‚  "furnace_furnaceconfig",    â”‚                             â”‚
â”‚                     â”‚  "furnace_config_parameters",â”‚                             â”‚
â”‚                     â”‚  "kpi_oee",                  â”‚                             â”‚
â”‚                     â”‚  "kpi_downtime",             â”‚                             â”‚
â”‚                     â”‚  "kpi_yield"}                â”‚                             â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Permission Mappings

**Function Codes â†’ Tables:**
| Code | Tables |
|------|--------|
| `PLT_CFG` | plant_plant |
| `FUR_MNT` | furnace_furnaceconfig, furnace_config_parameters |
| `LOG_BOOK` | log_book_furnace_down_time_event, log_book_reasons, log_book_downtime_type_master |
| `TAP_PROC` | core_process_tap_production, core_process_tap_process, core_process_tap_grading |

**KPI Metrics â†’ Tables (21 total):**
| Category | Codes |
|----------|-------|
| Performance | OEE, YIELD, DEFECT, PROD_EFF, OUTPUT, QTY_PROD, CYCLE_TIME, FPY, REWORK |
| Maintenance | DOWNTIME, MTBF, MTTR, MTBS, MAINT_COMP, PLAN_MAINT |
| Energy | ENERGY_EFF, ENERGY_USE |
| Capacity | CAPACITY, OTD |
| Safety | SAFETY |

---

## Request Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USER   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ 1. Ask: "What is the total downtime for last year?"
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         REACT FRONTEND                                â”‚
â”‚  â€¢ Capture user input                                                 â”‚
â”‚  â€¢ Get authToken from localStorage                                    â”‚
â”‚  â€¢ Call Django API with Bearer token                                  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. POST /api/chatbot/chat/
     â”‚    Headers: Authorization: Bearer <token>
     â”‚    Body: { question: "..." }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DJANGO BACKEND                                â”‚
â”‚                                                                        â”‚
â”‚  Step 2a: Rate Limiting (30 req/min per IP)                           â”‚
â”‚                                                                        â”‚
â”‚  Step 2b: RBAC Token Resolution                                       â”‚
â”‚  â”œâ”€â”€ Extract token from Authorization header                          â”‚
â”‚  â”œâ”€â”€ Lookup user via users_usertoken                                  â”‚
â”‚  â”œâ”€â”€ Get role permissions (function codes + KPIs)                     â”‚
â”‚  â””â”€â”€ Build allowed_tables whitelist                                   â”‚
â”‚                                                                        â”‚
â”‚  Step 2c: Forward to NLP Service with allowed_tables                  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 3. POST /api/v1/chat { question: "...", allowed_tables: [...] }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       NLP MICROSERVICE                                â”‚
â”‚                                                                        â”‚
â”‚  Step 3a: Security Layers                                             â”‚
â”‚  â”œâ”€â”€ Flipping Detector (jailbreak detection)                          â”‚
â”‚  â”œâ”€â”€ Prompt Validator (injection signatures)                          â”‚
â”‚  â”œâ”€â”€ Red Team Detector (attack patterns)                              â”‚
â”‚  â”œâ”€â”€ Guardrails AI (PII/profanity)                                    â”‚
â”‚  â””â”€â”€ Query Guard (relevance check)                                    â”‚
â”‚                                                                        â”‚
â”‚  Step 3b: Schema Filtering                                            â”‚
â”‚  â”œâ”€â”€ Filter TABLE_SCHEMA by allowed_tables                            â”‚
â”‚  â””â”€â”€ LLM only sees user's permitted tables                            â”‚
â”‚                                                                        â”‚
â”‚  Step 3c: LLM Generation (Groq)                                       â”‚
â”‚  â””â”€â”€ Generate SQL using filtered schema                               â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 4. Return { sql: "SELECT...", type: "sql" }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DJANGO BACKEND                                â”‚
â”‚                                                                        â”‚
â”‚  Step 4a: SQL Validation (Defense in Depth)                           â”‚
â”‚  â”œâ”€â”€ Block dangerous keywords (DROP, DELETE, etc.)                    â”‚
â”‚  â”œâ”€â”€ Extract tables from SQL                                          â”‚
â”‚  â””â”€â”€ Verify tables âŠ† allowed_tables                                   â”‚
â”‚                                                                        â”‚
â”‚  Step 4b: Execute Query (if validated)                                â”‚
â”‚  â””â”€â”€ Django executes SQL on PostgreSQL                                â”‚
â”‚                                                                        â”‚
â”‚  Step 4c: Audit Logging                                               â”‚
â”‚  â””â”€â”€ Log query with user context                                      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 5. Return results to frontend
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         REACT FRONTEND                                â”‚
â”‚  â€¢ Display bot message with natural language response                 â”‚
â”‚  â€¢ Show expandable SQL query                                          â”‚
â”‚  â€¢ Render results in formatted table                                  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 6. Display to user
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USER   â”‚  â† Sees answer, SQL, and data table
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Architecture

### 12-Layer Security Stack

| # | Layer | Location | Purpose |
|---|-------|----------|---------|
| 1 | Rate Limiter | Django | 30 req/min per IP |
| 2 | Token Validation | Django | Auth via users_usertoken |
| 3 | RBAC Service | Django | Token â†’ allowed_tables |
| 4 | Flipping Detector | NLP | Jailbreak detection |
| 5 | Prompt Validator | NLP | Injection signatures |
| 6 | Red Team Detector | NLP | Attack patterns |
| 7 | Guardrails AI | NLP | PII/profanity filter |
| 8 | Query Guard | NLP | Relevance check |
| 9 | Schema Filter | NLP | Only allowed tables in prompt |
| 10 | SQL Validator | Django | Block dangerous SQL |
| 11 | Table Validator | Django | RBAC defense-in-depth |
| 12 | Audit Logger | Django | Full query logging |

### Defense in Depth

```
User Input: "Show all users; DROP TABLE materials;"
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 4-8: NLP Service Security                                     â”‚
â”‚ â”œâ”€â”€ Flipping Detector: Check for jailbreak patterns                 â”‚
â”‚ â”œâ”€â”€ Prompt Validator: Check injection signatures                    â”‚
â”‚ â””â”€â”€ Query Guard: Check relevance to allowed tables                  â”‚
â”‚                                                                      â”‚
â”‚ If passed â†’ Generate SQL                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 10-11: Django Backend Validation                              â”‚
â”‚ â”œâ”€â”€ SQL Validator: Block DROP, DELETE, INSERT, UPDATE               â”‚
â”‚ â”œâ”€â”€ Table Validator: Extract tables, verify âŠ† allowed_tables        â”‚
â”‚ â””â”€â”€ Result: Query REJECTED, logged for security review              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File Structure

```
metalquery/
â”œâ”€â”€ backend/                      # Django (Port 8000)
â”‚   â”œâ”€â”€ chatbot/
â”‚   â”‚   â”œâ”€â”€ views.py             # Chat API, RBAC enforcement, SQL execution
â”‚   â”‚   â”œâ”€â”€ urls.py              # /chat/, /schema/, /health/
â”‚   â”‚   â””â”€â”€ services/
â”‚   â”‚       â””â”€â”€ rbac_service.py  # Token â†’ allowed_tables resolution
â”‚   â”œâ”€â”€ ignis/
â”‚   â”‚   â”œâ”€â”€ models.py            # KPI Django models
â”‚   â”‚   â””â”€â”€ schema/
â”‚   â”‚       â””â”€â”€ exposed_tables.py # Permission mappings
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ settings.py          # Django settings
â”‚   â”‚   â””â”€â”€ urls.py              # Root URL config
â”‚   â””â”€â”€ manage.py
â”‚
â”œâ”€â”€ nlp_service/                  # FastAPI (Port 8003)
â”‚   â”œâ”€â”€ main.py                  # Hybrid chat endpoint, security layers, viz pipeline
â”‚   â”œâ”€â”€ config.py                # Groq API config
â”‚   â”œâ”€â”€ prompts_v2.py            # Schema filtering, 29 tables
â”‚   â”œâ”€â”€ query_router.py          # SQL vs BRD routing
â”‚   â”œâ”€â”€ brd_rag.py               # BRD document handler
â”‚   â”œâ”€â”€ guardrails.py            # SQL validation with comment stripping
â”‚   â”œâ”€â”€ sql_guardrails.py        # SQL guardrails with table allowlist
â”‚   â”œâ”€â”€ security/                # Security modules
â”‚   â”‚   â”œâ”€â”€ flipping_detector.py
â”‚   â”‚   â”œâ”€â”€ anomaly_detector.py
â”‚   â”‚   â”œâ”€â”€ audit_logger.py
â”‚   â”‚   â””â”€â”€ sql_validator.py
â”‚   â”œâ”€â”€ visualization/           # LIDA-inspired chart generation
â”‚   â”‚   â”œâ”€â”€ viz_summarizer.py    # Column classification
â”‚   â”‚   â”œâ”€â”€ viz_goal_finder.py   # Chart type detection rules
â”‚   â”‚   â”œâ”€â”€ viz_config_generator.py # Recharts config generation
â”‚   â”‚   â””â”€â”€ viz_validator.py     # Config validation
â”‚   â””â”€â”€ brd/                     # BRD PDF documents
â”‚
â”œâ”€â”€ frontend/                     # React (Port 5173)
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ App.jsx              # Main chat component, auth handling
â”‚       â”œâ”€â”€ config.js            # API configuration (port 8000)
â”‚       â””â”€â”€ components/
â”‚           â””â”€â”€ ChartRenderer.jsx # Dynamic Recharts rendering
â”‚
â””â”€â”€ docs/                         # Documentation
    â”œâ”€â”€ RBAC_WORKFLOW_DIAGRAM.md
    â”œâ”€â”€ RBAC_MANUAL_TESTING_GUIDE.md
    â””â”€â”€ RBAC_QUICK_TEST_CHEATSHEET.md
```

---

## Configuration

### Environment Variables

```env
# Database
DB_HOST=localhost
DB_PORT=5432
DB_NAME=postgres
DB_USER=postgres
DB_PASSWORD=your_password

# Django
DJANGO_SECRET_KEY=your-secret-key
DEBUG=True

# NLP Service
NLP_SERVICE_URL=http://localhost:8003

# LLM (REQUIRED)
GROQ_API_KEY=your_groq_api_key
GROQ_MODEL=llama-3.3-70b-versatile
```

### Starting Services

```bash
# Terminal 1: Django Backend
cd backend
python manage.py runserver 8000

# Terminal 2: NLP Service
cd nlp_service
python main.py

# Terminal 3: React Frontend
cd frontend
npm start
```

---

## Infographics Pipeline (LIDA-Inspired)

The system includes a **4-stage visualization pipeline** inspired by Microsoft's LIDA framework. It automatically analyzes query results and generates the optimal chart type without user intervention.

### The Big Picture

```
User Question â†’ SQL Query â†’ Raw Data â†’ ğŸ¨ Viz Pipeline â†’ Beautiful Chart
                                              â”‚
                                    "What chart fits this data best?"
```

### 4-Stage Pipeline Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 1    â”‚ â†’ â”‚  STAGE 2    â”‚ â†’ â”‚  STAGE 3    â”‚ â†’ â”‚  STAGE 4    â”‚
â”‚ Summarizer  â”‚    â”‚ Goal Finder â”‚    â”‚  Config     â”‚    â”‚ Validator   â”‚
â”‚             â”‚    â”‚             â”‚    â”‚ Generator   â”‚    â”‚             â”‚
â”‚ "What kind  â”‚    â”‚ "What chart â”‚    â”‚ "Build the  â”‚    â”‚ "Is it safe â”‚
â”‚  of data?"  â”‚    â”‚  to use?"   â”‚    â”‚  recipe"    â”‚    â”‚  & correct?"â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Stage 1: Data Summarizer (`viz_summarizer.py`)

Analyzes SQL results to understand data characteristics.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  INPUT: SQL Results                                                              â”‚
â”‚  [{"furnace_id": "F1", "oee": 82.5}, {"furnace_id": "F2", "oee": 76.3}]         â”‚
â”‚                                                                                  â”‚
â”‚  OUTPUT: Data Summary                                                            â”‚
â”‚  {                                                                               â”‚
â”‚    "row_count": 2,                                                               â”‚
â”‚    "numeric_columns": ["oee"],           # Numbers (Y-axis candidates)          â”‚
â”‚    "categorical_columns": ["furnace_id"], # Labels (X-axis candidates)          â”‚
â”‚    "temporal_columns": [],                # Dates (time series)                 â”‚
â”‚    "is_comparison": true,                 # Multiple categories detected        â”‚
â”‚    "is_time_series": false                # No date column                      â”‚
â”‚  }                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Feature:** Distinguishes metric columns from temporal columns:
- `cycle_time`, `downtime`, `mtbf_hours` â†’ **Numeric** (not temporal)
- `date`, `timestamp`, `shift_date` â†’ **Temporal**

---

### Stage 2: Goal Finder (`viz_goal_finder.py`)

Determines the best chart type using pattern matching and heuristic rules.

**Decision Tree:**

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Does query have     â”‚
                    â”‚ "by X" pattern?     â”‚
                    â”‚ (by furnace, etc.)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ YES                           â”‚ NO
              â–¼                               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ BAR CHARTâ”‚                â”‚ Single value?   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ YES                         â”‚ NO
                              â–¼                             â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ PROGRESS   â”‚            â”‚ Time series?    â”‚
                        â”‚ BAR / KPI  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                           â”‚ YES                           â”‚ NO
                                           â–¼                               â–¼
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚ LINE CHART â”‚              â”‚ Distribution?   â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                         â”‚
                                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                                                         â”‚ YES                   â”‚ NO
                                                         â–¼                       â–¼
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚ PIE CHART  â”‚         â”‚ BAR CHART  â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ (default)  â”‚
                                                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Pattern Matching Examples:**

| User Query | Pattern Detected | Chart Selected |
|------------|------------------|----------------|
| "Show OEE **by furnace**" | `by X` pattern | ğŸ“Š Bar Chart |
| "What is current OEE?" | Single value | ğŸ“ˆ Progress Bar |
| "OEE **trend** this month" | Time + trend | ğŸ“‰ Line Chart |
| "**Breakdown** of defects" | Distribution | ğŸ¥§ Pie Chart |
| "**Compare** furnace performance" | Comparison | ğŸ“Š Bar Chart |

---

### Stage 3: Config Generator (`viz_config_generator.py`)

Creates Recharts-compatible JSON configuration.

**Example Output:**

```json
{
    "type": "bar",
    "data": [
        {"furnace_id": "F1", "oee": 82.5},
        {"furnace_id": "F2", "oee": 76.3}
    ],
    "options": {
        "xAxis": {"dataKey": "furnace_id", "label": "Furnace"},
        "yAxis": {"domain": [0, 100]},
        "bars": [{
            "dataKey": "oee",
            "fill": "#3b82f6",
            "name": "OEE %"
        }],
        "title": "OEE by Furnace"
    }
}
```

**Color Palette (DaVinci Design System):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Primary    Secondary   Success   Warning   Danger â”‚
â”‚  #3b82f6    #f97316    #22c55e   #f59e0b   #ef4444â”‚
â”‚  ğŸ”µ Blue    ğŸŸ  Orange   ğŸŸ¢ Green  ğŸŸ¡ Amber  ğŸ”´ Red  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Unit Detection:**

| Column Pattern | Unit | Max Value |
|---------------|------|-----------|
| `oee`, `yield`, `percentage` | % | 100 |
| `mtbf`, `mttr`, `hours` | hrs | 24 |
| `energy`, `kwh` | kWh | 10000 |
| `temperature`, `temp` | Â°C | 2000 |

---

### Stage 4: Validator (`viz_validator.py`)

Ensures config is safe and correct before rendering.

**Security Checks:**
- Blocks dangerous patterns: `onclick`, `<script>`, `javascript:`
- Blocks code execution attempts and prototype pollution
- Validates data structure and size limits

**Size Limits:**
- Max data points: 1,000
- Max string length: 500 chars
- Max recursion depth: 10 levels

---

### Chart Type Detection Keywords

| Chart Type | Keywords / Patterns |
|------------|---------------------|
| **Bar** | "compare", "versus", "by furnace", "by shift", "rank", "top", "which furnace" |
| **Line** | "trend", "over time", "last week", "last month", "daily", "history" |
| **Pie** | "breakdown", "distribution", "by reason", "by type", "proportion" |
| **Progress Bar** | Single row with OEE/yield/efficiency/rate percentage |
| **KPI Card** | Single row with count/total/quantity |

### Supported Chart Types

| Type | Component | Use Case |
|------|-----------|----------|
| `bar` | BarChart | Categorical comparisons (by furnace, by shift) |
| `line` | LineChart | Time series and trends |
| `pie` | PieChart | Distribution/breakdown (â‰¤8 categories) |
| `progress_bar` | Progress Bar | Single percentage metric (OEE, yield) |
| `kpi_card` | Card | Single numeric value |
| `metric_grid` | Grid | Multiple KPIs in one row |
| `table` | Table | Complex data (>20 rows, fallback) |

### Manufacturing KPI Templates

Pre-configured templates for common manufacturing metrics:

| KPI | Default Chart | Thresholds |
|-----|--------------|------------|
| OEE | Progress Bar | <50% ğŸ”´, <80% ğŸŸ¡, â‰¥80% ğŸŸ¢ |
| Yield | Progress Bar | <70% ğŸ”´, <90% ğŸŸ¡, â‰¥90% ğŸŸ¢ |
| Downtime | Bar Chart | - |
| MTBF | KPI Card | - |
| Energy | Line Chart | - |
| Defects | Pie Chart | - |

---

## Summary

| Component | Responsibility | Database Access |
|-----------|---------------|-----------------|
| React Frontend | User interface, auth token, chart rendering, voice input, export | None |
| Django Backend | Security, RBAC, DB access, chart config passthrough, STT proxy | Yes (Owner) |
| NLP Service | SQL generation, schema filtering, chart config, STT | None |
| Groq LLM | Natural language processing | None |
| PostgreSQL | Data storage | N/A (is the DB) |

**Key Principle:** The AI (NLP Service + Groq) never has direct database access. Django acts as the security gateway and is the sole owner of database credentials.

---

**Last Updated:** 2026-01-29
